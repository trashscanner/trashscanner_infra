name: Check Infrastructure Status

on:
  workflow_dispatch:
  schedule:
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 9:00 UTC
    - cron: '0 9 * * *'

jobs:
  check-status:
    name: Check Services Status
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests psycopg2-binary

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ vars.SERVER_HOST }} >> ~/.ssh/known_hosts
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Check Docker containers status
        run: |
          ssh -i ~/.ssh/deploy_key ${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }} \
            'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"' > container_status.txt
          cat container_status.txt
          
          echo "### Docker Containers Status ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat container_status.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check PostgreSQL connection
        run: |
          python3 << EOF
          import psycopg2
          import sys
          
          try:
              conn = psycopg2.connect(
                  host="${{ vars.SERVER_HOST }}",
                  port="${{ vars.POSTGRES_PORT }}",
                  user="${{ vars.POSTGRES_USER }}",
                  password="${{ secrets.POSTGRES_PASSWORD }}",
                  database="${{ vars.POSTGRES_DB }}",
                  connect_timeout=10
              )
              conn.close()
              print("âœ… PostgreSQL: Connection successful")
              sys.exit(0)
          except Exception as e:
              print(f"âŒ PostgreSQL: Connection failed - {e}")
              sys.exit(1)
          EOF

      - name: Check MinIO status
        run: |
          python3 << EOF
          import requests
          import sys
          
          try:
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° API
              response = requests.get(
                  "http://${{ vars.SERVER_HOST }}:${{ vars.MINIO_PORT }}/minio/health/live",
                  timeout=10
              )
              if response.status_code == 200:
                  print("âœ… MinIO API: Healthy")
              else:
                  print(f"âš ï¸  MinIO API: Status code {response.status_code}")
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸
              response = requests.get(
                  "http://${{ vars.SERVER_HOST }}:${{ vars.MINIO_CONSOLE_PORT }}",
                  timeout=10
              )
              if response.status_code in [200, 301, 302]:
                  print("âœ… MinIO Console: Accessible")
              else:
                  print(f"âš ï¸  MinIO Console: Status code {response.status_code}")
                  
          except Exception as e:
              print(f"âŒ MinIO: Check failed - {e}")
              sys.exit(1)
          EOF

      - name: Check disk usage
        run: |
          ssh -i ~/.ssh/deploy_key ${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }} \
            'df -h /opt/trashscanner /var/lib/docker' > disk_usage.txt || true
          
          echo "### Disk Usage ðŸ’¾" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat disk_usage.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Final status
        if: success()
        run: |
          echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure is healthy and running." >> $GITHUB_STEP_SUMMARY
