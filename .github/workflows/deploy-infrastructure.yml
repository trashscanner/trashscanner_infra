name: Deploy TrashScanner Infrastructure

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: true
        type: choice
        options:
          - postgres
          - minio
          - all
        default: 'all'

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ vars.SERVER_HOST }} >> ~/.ssh/known_hosts
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Create Ansible variables file
        run: |
          cat > ansible/vars/secrets.yml << EOF
          server_host: "${{ vars.SERVER_HOST }}"
          server_user: "${{ vars.SERVER_USER }}"
          ansible_become_password: "${{ secrets.ANSIBLE_BECOME_PASSWORD }}"
          
          # PostgreSQL configuration
          postgres_user: "${{ vars.POSTGRES_USER }}"
          postgres_password: "${{ secrets.POSTGRES_PASSWORD }}"
          postgres_db: "${{ vars.POSTGRES_DB }}"
          postgres_port: "${{ vars.POSTGRES_PORT }}"
          
          # MinIO configuration
          minio_root_user: "${{ vars.MINIO_ROOT_USER }}"
          minio_root_password: "${{ secrets.MINIO_ROOT_PASSWORD }}"
          minio_port: "${{ vars.MINIO_PORT }}"
          minio_console_port: "${{ vars.MINIO_CONSOLE_PORT }}"
          minio_bucket: "${{ vars.MINIO_BUCKET }}"
          
          # Deployment mode
          deployment_mode: "${{ github.event.inputs.mode }}"
          EOF

      - name: Run Ansible playbook
        run: |
          cd ansible
          ansible-playbook -i inventory/hosts.yml \
            --private-key ~/.ssh/deploy_key \
            --user "${{ vars.SERVER_USER }}" \
            --extra-vars "@vars/secrets.yml" \
            playbooks/deploy.yml

      - name: Deployment summary
        run: |
          echo "### Deployment completed successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ vars.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.mode }}" == "postgres" ] || [ "${{ github.event.inputs.mode }}" == "all" ]; then
            echo "âœ… PostgreSQL deployed on port ${{ vars.POSTGRES_PORT }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.mode }}" == "minio" ] || [ "${{ github.event.inputs.mode }}" == "all" ]; then
            echo "âœ… MinIO deployed on port ${{ vars.MINIO_PORT }}" >> $GITHUB_STEP_SUMMARY
            echo "âœ… MinIO Console on port ${{ vars.MINIO_CONSOLE_PORT }}" >> $GITHUB_STEP_SUMMARY
          fi
